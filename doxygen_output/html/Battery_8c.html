<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>My Project: source/modules/Battery.c File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">My Project
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="dir_b2f33c71d4aa5e7af42a1ca61ff5af1b.html">source</a></li><li class="navelem"><a class="el" href="dir_cd7a448e5c16e17955dd008163ffcdf4.html">modules</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="summary">
<a href="#define-members">Macros</a> &#124;
<a href="#func-members">Functions</a> &#124;
<a href="#var-members">Variables</a>  </div>
  <div class="headertitle"><div class="title">Battery.c File Reference</div></div>
</div><!--header-->
<div class="contents">

<p>Implementation of the Battery Management module for the BMS system.  
<a href="#details">More...</a></p>
<div class="textblock"><code>#include &quot;<a class="el" href="Battery_8h_source.html">Battery.h</a>&quot;</code><br />
</div><div class="textblock"><div class="dynheader">
Include dependency graph for Battery.c:</div>
<div class="dyncontent">
<div class="center"><img src="Battery_8c__incl.png" border="0" usemap="#asource_2modules_2Battery_8c" alt=""/></div>
<map name="asource_2modules_2Battery_8c" id="asource_2modules_2Battery_8c">
<area shape="rect" title="Implementation of the Battery Management module for the BMS system." alt="" coords="387,5,574,31"/>
<area shape="rect" href="Battery_8h.html" title="API&#45;definition for the battery&#45;module in the BMS&#45;System." alt="" coords="441,79,521,104"/>
<area shape="poly" title=" " alt="" coords="483,31,483,65,478,65,478,31"/>
<area shape="rect" title=" " alt="" coords="180,225,339,251"/>
<area shape="poly" title=" " alt="" coords="444,107,395,126,344,154,308,185,279,216,275,213,304,181,340,150,392,121,442,102"/>
<area shape="rect" title=" " alt="" coords="363,225,518,251"/>
<area shape="poly" title=" " alt="" coords="493,103,512,137,516,158,512,178,496,202,475,220,472,216,492,198,508,176,511,158,507,139,488,106"/>
<area shape="rect" href="SPI__MB_8h.html" title="API&#45;definition for the SPI Module in the BMS&#45;System." alt="" coords="197,152,279,177"/>
<area shape="poly" title=" " alt="" coords="442,107,291,151,289,146,441,101"/>
<area shape="rect" href="CAN__Bus_8h.html" title="API&#45;definition for the Can module in the BMS&#45;System." alt="" coords="573,152,666,177"/>
<area shape="poly" title=" " alt="" coords="497,102,579,144,576,148,495,106"/>
<area shape="rect" href="shutdown__circuit_8h.html" title="API&#45;definition for the shutdown&#45;circuit&#45;module in the BMS&#45;System." alt="" coords="354,152,498,177"/>
<area shape="poly" title=" " alt="" coords="467,106,437,142,433,139,463,103"/>
<area shape="rect" href="Status__error__flags_8h.html" title="Flags for the Battery in the BMS&#45;System." alt="" coords="721,225,872,251"/>
<area shape="poly" title=" " alt="" coords="522,98,596,118,679,150,732,181,775,214,771,218,729,186,677,154,595,123,520,103"/>
<area shape="poly" title=" " alt="" coords="244,177,255,211,249,213,239,178"/>
<area shape="poly" title=" " alt="" coords="271,175,396,218,394,223,270,180"/>
<area shape="rect" title=" " alt="" coords="5,225,156,251"/>
<area shape="poly" title=" " alt="" coords="214,180,120,222,118,217,212,175"/>
<area shape="poly" title=" " alt="" coords="602,154,521,112,523,107,605,149"/>
<area shape="poly" title=" " alt="" coords="592,180,483,223,481,218,590,175"/>
<area shape="rect" title=" " alt="" coords="542,225,697,251"/>
<area shape="poly" title=" " alt="" coords="622,178,622,212,617,212,617,178"/>
<area shape="poly" title=" " alt="" coords="440,150,469,114,473,118,444,154"/>
<area shape="poly" title=" " alt="" coords="400,180,300,222,298,217,398,175"/>
<area shape="poly" title=" " alt="" coords="431,177,438,211,433,212,426,178"/>
<area shape="poly" title=" " alt="" coords="486,175,724,220,723,225,485,180"/>
</map>
</div>
</div><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="define-members" name="define-members"></a>
Macros</h2></td></tr>
<tr class="memitem:aa1b7f28cab3457041eee33e4436badbd" id="r_aa1b7f28cab3457041eee33e4436badbd"><td class="memItemLeft" align="right" valign="top"><a id="aa1b7f28cab3457041eee33e4436badbd" name="aa1b7f28cab3457041eee33e4436badbd"></a>
#define&#160;</td><td class="memItemRight" valign="bottom"><b>BATTERY_MONITOR_STACK_SIZE</b>&#160;&#160;&#160;1024</td></tr>
<tr class="separator:aa1b7f28cab3457041eee33e4436badbd"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a757e93662a68969088e163332e18b450" id="r_a757e93662a68969088e163332e18b450"><td class="memItemLeft" align="right" valign="top"><a id="a757e93662a68969088e163332e18b450" name="a757e93662a68969088e163332e18b450"></a>
#define&#160;</td><td class="memItemRight" valign="bottom"><b>BATTERY_MONITOR_THREAD_PRIORITY</b>&#160;&#160;&#160;8</td></tr>
<tr class="separator:a757e93662a68969088e163332e18b450"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a4c3d431aac727877403bd75eb0e45ad9" id="r_a4c3d431aac727877403bd75eb0e45ad9"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="Battery_8c.html#a4c3d431aac727877403bd75eb0e45ad9">CHECK_READY</a>(spec)</td></tr>
<tr class="separator:a4c3d431aac727877403bd75eb0e45ad9"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="func-members" name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:ae2307c38840fe9593ff44c4c0309d251" id="r_ae2307c38840fe9593ff44c4c0309d251"><td class="memItemLeft" align="right" valign="top"><a id="ae2307c38840fe9593ff44c4c0309d251" name="ae2307c38840fe9593ff44c4c0309d251"></a>
&#160;</td><td class="memItemRight" valign="bottom"><b>K_EVENT_DEFINE</b> (<a class="el" href="Battery_8h.html#af3144e669fb7b16c9ce34ef489abaa20">error_to_main</a>)</td></tr>
<tr class="separator:ae2307c38840fe9593ff44c4c0309d251"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a106ea8f612c0e229b5e500801342a3c7" id="r_a106ea8f612c0e229b5e500801342a3c7"><td class="memItemLeft" align="right" valign="top"><a id="a106ea8f612c0e229b5e500801342a3c7" name="a106ea8f612c0e229b5e500801342a3c7"></a>
&#160;</td><td class="memItemRight" valign="bottom"><b>LOG_MODULE_REGISTER</b> (battery, LOG_LEVEL_DBG)</td></tr>
<tr class="separator:a106ea8f612c0e229b5e500801342a3c7"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a6642727f4adb753108124cba3c8aeb9a" id="r_a6642727f4adb753108124cba3c8aeb9a"><td class="memItemLeft" align="right" valign="top"><a id="a6642727f4adb753108124cba3c8aeb9a" name="a6642727f4adb753108124cba3c8aeb9a"></a>
&#160;</td><td class="memItemRight" valign="bottom"><b>K_THREAD_STACK_DEFINE</b> (battery_monitor_thread_stack, BATTERY_MONITOR_STACK_SIZE)</td></tr>
<tr class="separator:a6642727f4adb753108124cba3c8aeb9a"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aed529d1573366fac065ace2f85f5546f" id="r_aed529d1573366fac065ace2f85f5546f"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="Battery_8c.html#aed529d1573366fac065ace2f85f5546f">battery_reset_error_flags</a> (void)</td></tr>
<tr class="memdesc:aed529d1573366fac065ace2f85f5546f"><td class="mdescLeft">&#160;</td><td class="mdescRight">Clears all stored error flags in the battery system.  <br /></td></tr>
<tr class="separator:aed529d1573366fac065ace2f85f5546f"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a3d2d5ff92bcffda6ddcb8b91990d4026" id="r_a3d2d5ff92bcffda6ddcb8b91990d4026"><td class="memItemLeft" align="right" valign="top">uint8_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="Battery_8c.html#a3d2d5ff92bcffda6ddcb8b91990d4026">battery_get_error_code</a> (void)</td></tr>
<tr class="memdesc:a3d2d5ff92bcffda6ddcb8b91990d4026"><td class="mdescLeft">&#160;</td><td class="mdescRight">Retrieves the current battery error code.  <br /></td></tr>
<tr class="separator:a3d2d5ff92bcffda6ddcb8b91990d4026"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a31483142119b07f37b32e84d0d3d1c01" id="r_a31483142119b07f37b32e84d0d3d1c01"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="Battery_8c.html#a31483142119b07f37b32e84d0d3d1c01">battery_set_error_flag</a> (uint8_t mask)</td></tr>
<tr class="memdesc:a31483142119b07f37b32e84d0d3d1c01"><td class="mdescLeft">&#160;</td><td class="mdescRight">Sets specified error flags in the battery system.  <br /></td></tr>
<tr class="separator:a31483142119b07f37b32e84d0d3d1c01"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a703e5120a4fa20231099dd595baeb6b8" id="r_a703e5120a4fa20231099dd595baeb6b8"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="Battery_8c.html#a703e5120a4fa20231099dd595baeb6b8">battery_set_reset_status_flag</a> (uint8_t set, uint8_t mask)</td></tr>
<tr class="memdesc:a703e5120a4fa20231099dd595baeb6b8"><td class="mdescLeft">&#160;</td><td class="mdescRight">Sets or clears specified status flags in the battery system.  <br /></td></tr>
<tr class="separator:a703e5120a4fa20231099dd595baeb6b8"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a804f9a31ed54e56cb175cbfccb440859" id="r_a804f9a31ed54e56cb175cbfccb440859"><td class="memItemLeft" align="right" valign="top">uint8_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="Battery_8c.html#a804f9a31ed54e56cb175cbfccb440859">battery_get_status_code</a> (void)</td></tr>
<tr class="memdesc:a804f9a31ed54e56cb175cbfccb440859"><td class="mdescLeft">&#160;</td><td class="mdescRight">Update and return the aggregated battery status flags.  <br /></td></tr>
<tr class="separator:a804f9a31ed54e56cb175cbfccb440859"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:afe5246deaa213114998d43a2cd15b109" id="r_afe5246deaa213114998d43a2cd15b109"><td class="memItemLeft" align="right" valign="top"><a class="el" href="structBatterySystemTypeDef.html">BatterySystemTypeDef</a> *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="Battery_8c.html#afe5246deaa213114998d43a2cd15b109">battery_calc_values</a> (const uint16_t *volt_data, const uint16_t *temp_data)</td></tr>
<tr class="memdesc:afe5246deaa213114998d43a2cd15b109"><td class="mdescLeft">&#160;</td><td class="mdescRight">Computes aggregate battery metrics from raw ADC readings.  <br /></td></tr>
<tr class="separator:afe5246deaa213114998d43a2cd15b109"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a778f618f566846d1286db3b4639542c1" id="r_a778f618f566846d1286db3b4639542c1"><td class="memItemLeft" align="right" valign="top">uint8_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="Battery_8c.html#a778f618f566846d1286db3b4639542c1">battery_volt2celsius</a> (uint16_t volt_100uV)</td></tr>
<tr class="memdesc:a778f618f566846d1286db3b4639542c1"><td class="mdescLeft">&#160;</td><td class="mdescRight">Convert a raw voltage reading to temperature in degrees Celsius.  <br /></td></tr>
<tr class="separator:a778f618f566846d1286db3b4639542c1"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ad37e4aaaf5b216f5f9c206fb5bcdb484" id="r_ad37e4aaaf5b216f5f9c206fb5bcdb484"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="Battery_8c.html#ad37e4aaaf5b216f5f9c206fb5bcdb484">battery_check_state</a> (void)</td></tr>
<tr class="memdesc:ad37e4aaaf5b216f5f9c206fb5bcdb484"><td class="mdescLeft">&#160;</td><td class="mdescRight">Perform a single battery measurement cycle and update status.  <br /></td></tr>
<tr class="separator:ad37e4aaaf5b216f5f9c206fb5bcdb484"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:af385b966f1d9efcea35e6f937d05aad5" id="r_af385b966f1d9efcea35e6f937d05aad5"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="Battery_8c.html#af385b966f1d9efcea35e6f937d05aad5">battery_stop_balancing</a> (void)</td></tr>
<tr class="memdesc:af385b966f1d9efcea35e6f937d05aad5"><td class="mdescLeft">&#160;</td><td class="mdescRight">Ceases all cell balancing operations.  <br /></td></tr>
<tr class="separator:af385b966f1d9efcea35e6f937d05aad5"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a5fd382350295e8c184dd2e1cc4e43472" id="r_a5fd382350295e8c184dd2e1cc4e43472"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="Battery_8c.html#a5fd382350295e8c184dd2e1cc4e43472">balancing</a> (void)</td></tr>
<tr class="memdesc:a5fd382350295e8c184dd2e1cc4e43472"><td class="mdescLeft">&#160;</td><td class="mdescRight">Perform cell balancing based on voltage differentials and internal temperature.  <br /></td></tr>
<tr class="separator:a5fd382350295e8c184dd2e1cc4e43472"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:af287da21f3332d6eaf42c4a6f598671a" id="r_af287da21f3332d6eaf42c4a6f598671a"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="Battery_8c.html#af287da21f3332d6eaf42c4a6f598671a">battery_precharge_logic</a> (void)</td></tr>
<tr class="memdesc:af287da21f3332d6eaf42c4a6f598671a"><td class="mdescLeft">&#160;</td><td class="mdescRight">Handle precharge relay logic based on Precharge_EN input transitions.  <br /></td></tr>
<tr class="separator:af287da21f3332d6eaf42c4a6f598671a"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a192bdfe743d2e7e6e203007d2e5972e3" id="r_a192bdfe743d2e7e6e203007d2e5972e3"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="Battery_8c.html#a192bdfe743d2e7e6e203007d2e5972e3">battery_charging</a> (void)</td></tr>
<tr class="memdesc:a192bdfe743d2e7e6e203007d2e5972e3"><td class="mdescLeft">&#160;</td><td class="mdescRight">Update charging state and invoke balancing or shutdown.  <br /></td></tr>
<tr class="separator:a192bdfe743d2e7e6e203007d2e5972e3"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a5212becce11bf07c1a0b4a2b2e260629" id="r_a5212becce11bf07c1a0b4a2b2e260629"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="Battery_8c.html#a5212becce11bf07c1a0b4a2b2e260629">battery_set_time_per_measurement</a> (void)</td></tr>
<tr class="memdesc:a5212becce11bf07c1a0b4a2b2e260629"><td class="mdescLeft">&#160;</td><td class="mdescRight">Set the measurement interval for the battery monitoring cycle.  <br /></td></tr>
<tr class="separator:a5212becce11bf07c1a0b4a2b2e260629"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ac26d041ed94490f19e6f53c6adddf671" id="r_ac26d041ed94490f19e6f53c6adddf671"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="Battery_8c.html#ac26d041ed94490f19e6f53c6adddf671">battery_refresh_ivt_timer</a> (void)</td></tr>
<tr class="memdesc:ac26d041ed94490f19e6f53c6adddf671"><td class="mdescLeft">&#160;</td><td class="mdescRight">Reset the IVT timer.  <br /></td></tr>
<tr class="separator:ac26d041ed94490f19e6f53c6adddf671"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a339aafee9c7b06a028957cfe98637d48" id="r_a339aafee9c7b06a028957cfe98637d48"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="Battery_8c.html#a339aafee9c7b06a028957cfe98637d48">battery_monitor_thread</a> (void *arg1, void *arg2, void *arg3)</td></tr>
<tr class="memdesc:a339aafee9c7b06a028957cfe98637d48"><td class="mdescLeft">&#160;</td><td class="mdescRight">Thread function for continuous battery monitoring.  <br /></td></tr>
<tr class="separator:a339aafee9c7b06a028957cfe98637d48"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a96004bd7cd7a80ef1f8145c63026a49a" id="r_a96004bd7cd7a80ef1f8145c63026a49a"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="Battery_8c.html#a96004bd7cd7a80ef1f8145c63026a49a">battery_init</a> (void)</td></tr>
<tr class="memdesc:a96004bd7cd7a80ef1f8145c63026a49a"><td class="mdescLeft">&#160;</td><td class="mdescRight">Initialize the GPIO inputs for battery status pins.  <br /></td></tr>
<tr class="separator:a96004bd7cd7a80ef1f8145c63026a49a"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="var-members" name="var-members"></a>
Variables</h2></td></tr>
<tr class="memitem:af3144e669fb7b16c9ce34ef489abaa20" id="r_af3144e669fb7b16c9ce34ef489abaa20"><td class="memItemLeft" align="right" valign="top"><a id="af3144e669fb7b16c9ce34ef489abaa20" name="af3144e669fb7b16c9ce34ef489abaa20"></a>
struct k_event&#160;</td><td class="memItemRight" valign="bottom"><b>error_to_main</b></td></tr>
<tr class="memdesc:af3144e669fb7b16c9ce34ef489abaa20"><td class="mdescLeft">&#160;</td><td class="mdescRight">Event signaling errors to the main control loop. <br /></td></tr>
<tr class="separator:af3144e669fb7b16c9ce34ef489abaa20"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a1b1be4cc2b733542a67d6010e0718d11" id="r_a1b1be4cc2b733542a67d6010e0718d11"><td class="memItemLeft" align="right" valign="top"><a id="a1b1be4cc2b733542a67d6010e0718d11" name="a1b1be4cc2b733542a67d6010e0718d11"></a>
<a class="el" href="structBatterySystemTypeDef.html">BatterySystemTypeDef</a>&#160;</td><td class="memItemRight" valign="bottom"><b>battery_values</b></td></tr>
<tr class="memdesc:a1b1be4cc2b733542a67d6010e0718d11"><td class="mdescLeft">&#160;</td><td class="mdescRight">Global instance containing the latest battery values. <br /></td></tr>
<tr class="separator:a1b1be4cc2b733542a67d6010e0718d11"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a1b6ce18e2e3c0834d20037ee1846ca3a" id="r_a1b6ce18e2e3c0834d20037ee1846ca3a"><td class="memItemLeft" align="right" valign="top"><a id="a1b6ce18e2e3c0834d20037ee1846ca3a" name="a1b6ce18e2e3c0834d20037ee1846ca3a"></a>
struct k_thread&#160;</td><td class="memItemRight" valign="bottom"><b>battery_monitor_thread_data</b></td></tr>
<tr class="separator:a1b6ce18e2e3c0834d20037ee1846ca3a"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>Implementation of the Battery Management module for the BMS system. </p>
<p>This module initializes battery monitoring GPIOs, manages battery-related data structures, starts the monitoring thread, and checks battery and shutdown circuit status. It also provides error detection and communication mechanisms.</p>
<ul>
<li>Initializes critical GPIOs for voltage, temperature, and charger state.</li>
<li>Launches a dedicated monitoring thread that performs periodic health checks.</li>
<li>Maintains battery state and error flags in a shared structure.</li>
<li>Signals critical errors to the main control loop via Zephyr's event API.</li>
</ul>
<dl class="section author"><dt>Author</dt><dd>renolluc / grossfa2 </dd></dl>
<dl class="section date"><dt>Date</dt><dd>20.04.2025 </dd></dl>
</div><h2 class="groupheader">Macro Definition Documentation</h2>
<a id="a4c3d431aac727877403bd75eb0e45ad9" name="a4c3d431aac727877403bd75eb0e45ad9"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a4c3d431aac727877403bd75eb0e45ad9">&#9670;&#160;</a></span>CHECK_READY</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define CHECK_READY</td>
          <td>(</td>
          <td class="paramtype">&#160;</td>
          <td class="paramname">spec</td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<b>Value:</b><div class="fragment"><div class="line">    <span class="keywordflow">do</span>                                        \</div>
<div class="line">    {                                         \</div>
<div class="line">        if (!device_is_ready((spec).port))    \</div>
<div class="line">        {                                     \</div>
<div class="line">            LOG_ERR(<span class="stringliteral">&quot;GPIO port %s not ready&quot;</span>, \</div>
<div class="line">                    ((spec).port)-&gt;name);     \</div>
<div class="line">            <span class="keywordflow">return</span> -ENODEV;                   \</div>
<div class="line">        }                                     \</div>
<div class="line">    } <span class="keywordflow">while</span> (0)</div>
</div><!-- fragment -->
</div>
</div>
<h2 class="groupheader">Function Documentation</h2>
<a id="a5fd382350295e8c184dd2e1cc4e43472" name="a5fd382350295e8c184dd2e1cc4e43472"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a5fd382350295e8c184dd2e1cc4e43472">&#9670;&#160;</a></span>balancing()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void balancing </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Perform cell balancing based on voltage differentials and internal temperature. </p>
<p>This function reads the internal die temperature via SPI. If the temperature exceeds the safety threshold (83 °C), balancing is immediately stopped. Otherwise, if the highest cell voltage is at or above 4.10 V (41000 in raw units), it computes a per‑cell discharge mask: any cell whose voltage exceeds the lowest cell voltage by more than 100 units is flagged for balancing. The resulting mask array is sent to the ADBMS devices to activate cell‑discharge circuits. If the highest cell voltage is below the threshold, balancing is also stopped.</p>
<dl class="section note"><dt>Note</dt><dd><ul>
<li>Uses <code><a class="el" href="SPI__MB_8h.html#a756ec752a2f31def349d63920a309b52" title="Reads and returns the maximum temperature from ADBMS status registers.">spi_read_adbms_temp()</a></code> and <code><a class="el" href="SPI__MB_8h.html#af2451e5eba282f92947029ee03594821" title="Configures cell discharge (balancing) settings via SPI.">spi_set_discharge_cell_x()</a></code>, which return negative errno codes on failure. </li>
</ul>
</dd></dl>

</div>
</div>
<a id="afe5246deaa213114998d43a2cd15b109" name="afe5246deaa213114998d43a2cd15b109"></a>
<h2 class="memtitle"><span class="permalink"><a href="#afe5246deaa213114998d43a2cd15b109">&#9670;&#160;</a></span>battery_calc_values()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="structBatterySystemTypeDef.html">BatterySystemTypeDef</a> * battery_calc_values </td>
          <td>(</td>
          <td class="paramtype">const uint16_t *&#160;</td>
          <td class="paramname"><em>volt_data</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const uint16_t *&#160;</td>
          <td class="paramname"><em>temp_data</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Computes aggregate battery metrics from raw ADC readings. </p>
<p>This function processes arrays of raw cell voltages and temperatures to compute:</p><ul>
<li>Total pack voltage (in 0.1 V units)</li>
<li>Mean cell voltage</li>
<li>Minimum and maximum cell voltages</li>
<li>Mean cell temperature</li>
<li>Minimum and maximum cell temperatures</li>
</ul>
<p>Two known-unpopulated cells (indices 142 and 143) are skipped in the voltage loop, and two faulty temperature sensors (indices 1 and 26) are skipped in the temperature loop.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">volt_data</td><td>Pointer to an array of raw voltage readings. Must be at least NUM_OF_CLIENTS * 18 elements long. </td></tr>
    <tr><td class="paramname">temp_data</td><td>Pointer to an array of raw temperature readings. Must be at least NUM_OF_CLIENTS * 8 elements long. </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>Pointer to the global <a class="el" href="structBatterySystemTypeDef.html" title="Battery system state representation.">BatterySystemTypeDef</a> instance (<code>battery_values</code>), updated with the computed metrics. </dd></dl>

</div>
</div>
<a id="a192bdfe743d2e7e6e203007d2e5972e3" name="a192bdfe743d2e7e6e203007d2e5972e3"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a192bdfe743d2e7e6e203007d2e5972e3">&#9670;&#160;</a></span>battery_charging()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void battery_charging </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Update charging state and invoke balancing or shutdown. </p>
<p>Handles the charging logic including balance management.</p>
<p>This function must be called periodically (e.g., in the main loop or a timer thread). It first runs the precharge logic, then reads the charger‐connected sense pin.</p>
<p>Active‐low logic:</p><ul>
<li>0 =&gt; charger connected</li>
<li>1 =&gt; charger disconnected</li>
</ul>
<p>If the charger has just connected, it sets the STATUS_CHARGING flag; if already charging, it continues balancing. On disconnect, it clears STATUS_CHARGING, resets the internal temperature, and stops balancing. </p>

</div>
</div>
<a id="ad37e4aaaf5b216f5f9c206fb5bcdb484" name="ad37e4aaaf5b216f5f9c206fb5bcdb484"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ad37e4aaaf5b216f5f9c206fb5bcdb484">&#9670;&#160;</a></span>battery_check_state()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int battery_check_state </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Perform a single battery measurement cycle and update status. </p>
<p>Checks for system errors and updates the battery error state accordingly.</p>
<p>This function reads all cell voltages and temperatures, updates error flags on SPI communication failures, computes aggregate metrics, checks for limit violations, and finally refreshes the external SD‑Card interface.</p>
<p>On Zephyr RTOS, all delays and error codes follow POSIX conventions; no HAL types are used. The measurement functions return negative errno on failure, or 0 on success.</p>
<dl class="section return"><dt>Returns</dt><dd>int Current overall system status after SD‑Card refresh. </dd></dl>

</div>
</div>
<a id="a3d2d5ff92bcffda6ddcb8b91990d4026" name="a3d2d5ff92bcffda6ddcb8b91990d4026"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a3d2d5ff92bcffda6ddcb8b91990d4026">&#9670;&#160;</a></span>battery_get_error_code()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">uint8_t battery_get_error_code </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Retrieves the current battery error code. </p>
<p>Retrieves the current error bitfield from the battery system.</p>
<p>This function returns the internal error bitfield, where each bit represents a specific error condition in the battery management system.</p>
<dl class="section return"><dt>Returns</dt><dd>The 8‑bit error code (bitfield) from battery_values.error. </dd></dl>

</div>
</div>
<a id="a804f9a31ed54e56cb175cbfccb440859" name="a804f9a31ed54e56cb175cbfccb440859"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a804f9a31ed54e56cb175cbfccb440859">&#9670;&#160;</a></span>battery_get_status_code()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">uint8_t battery_get_status_code </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Update and return the aggregated battery status flags. </p>
<p>Retrieves the current status bitfield from the battery system.</p>
<p>Reads the error state, ADBMS internal temperature, and the three GPIO status inputs (AIR positive, AIR negative, Precharge) via Zephyr's GPIO API, and sets or clears the corresponding bits in battery_values.status.</p>
<dl class="section return"><dt>Returns</dt><dd>The current battery status bitfield. </dd></dl>

</div>
</div>
<a id="a96004bd7cd7a80ef1f8145c63026a49a" name="a96004bd7cd7a80ef1f8145c63026a49a"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a96004bd7cd7a80ef1f8145c63026a49a">&#9670;&#160;</a></span>battery_init()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int battery_init </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Initialize the GPIO inputs for battery status pins. </p>
<p>Initializes GPIOs related to battery feedback and charger sensing.</p>
<p>Must be called once during system init before reading status.</p>
<dl class="section return"><dt>Returns</dt><dd>0 on success, negative errno otherwise. </dd></dl>

</div>
</div>
<a id="a339aafee9c7b06a028957cfe98637d48" name="a339aafee9c7b06a028957cfe98637d48"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a339aafee9c7b06a028957cfe98637d48">&#9670;&#160;</a></span>battery_monitor_thread()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void battery_monitor_thread </td>
          <td>(</td>
          <td class="paramtype">void *&#160;</td>
          <td class="paramname"><em>arg1</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">void *&#160;</td>
          <td class="paramname"><em>arg2</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">void *&#160;</td>
          <td class="paramname"><em>arg3</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Thread function for continuous battery monitoring. </p>
<p>This thread performs periodic health checks on the battery system and shutdown circuit. It operates as follows:</p><ul>
<li>Resets error flags at the beginning of each cycle</li>
<li>Executes checks for battery, shutdown state, and feedback</li>
<li>Increments an internal error counter if any check fails</li>
<li>If ≥ 3 consecutive errors occur, an error event is posted to the main thread</li>
<li>If no errors are present, the counter is reset</li>
<li>Records the measurement timestamp</li>
</ul>
<p>The thread runs continuously with a 100ms delay between cycles.</p>
<dl class="section note"><dt>Note</dt><dd>Errors are only signaled after three consecutive fault detections. </dd></dl>

</div>
</div>
<a id="af287da21f3332d6eaf42c4a6f598671a" name="af287da21f3332d6eaf42c4a6f598671a"></a>
<h2 class="memtitle"><span class="permalink"><a href="#af287da21f3332d6eaf42c4a6f598671a">&#9670;&#160;</a></span>battery_precharge_logic()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int battery_precharge_logic </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Handle precharge relay logic based on Precharge_EN input transitions. </p>
<p>Executes precharge logic by managing AIR +/- and precharge relays.</p>
<p>This function is called when the Precharge should be enabled It drives the AIR and precharge relays to prepare for charging. </p>

</div>
</div>
<a id="ac26d041ed94490f19e6f53c6adddf671" name="ac26d041ed94490f19e6f53c6adddf671"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ac26d041ed94490f19e6f53c6adddf671">&#9670;&#160;</a></span>battery_refresh_ivt_timer()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void battery_refresh_ivt_timer </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Reset the IVT timer. </p>
<p>Refreshes the IVT (current sensor) watchdog timer.</p>
<p>This function resets the IVT timer to the current time plus the IVT_TIMEOUT_MS </p>

</div>
</div>
<a id="aed529d1573366fac065ace2f85f5546f" name="aed529d1573366fac065ace2f85f5546f"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aed529d1573366fac065ace2f85f5546f">&#9670;&#160;</a></span>battery_reset_error_flags()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void battery_reset_error_flags </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Clears all stored error flags in the battery system. </p>
<p>Resets all battery error flags to zero.</p>
<p>This function resets the internal error bitfield to zero, indicating that no error conditions are currently active. </p>

</div>
</div>
<a id="a31483142119b07f37b32e84d0d3d1c01" name="a31483142119b07f37b32e84d0d3d1c01"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a31483142119b07f37b32e84d0d3d1c01">&#9670;&#160;</a></span>battery_set_error_flag()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void battery_set_error_flag </td>
          <td>(</td>
          <td class="paramtype">uint8_t&#160;</td>
          <td class="paramname"><em>mask</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Sets specified error flags in the battery system. </p>
<p>Sets error flags in the battery error field.</p>
<p>This function OR‑combines the provided mask into the internal error bitfield, enabling one or more error condition flags while preserving existing ones.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">mask</td><td>Bitmask representing the error flags to set. </td></tr>
  </table>
  </dd>
</dl>

</div>
</div>
<a id="a703e5120a4fa20231099dd595baeb6b8" name="a703e5120a4fa20231099dd595baeb6b8"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a703e5120a4fa20231099dd595baeb6b8">&#9670;&#160;</a></span>battery_set_reset_status_flag()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void battery_set_reset_status_flag </td>
          <td>(</td>
          <td class="paramtype">uint8_t&#160;</td>
          <td class="paramname"><em>set</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">uint8_t&#160;</td>
          <td class="paramname"><em>mask</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Sets or clears specified status flags in the battery system. </p>
<p>This function modifies the internal status bitfield by either setting or clearing the bits defined in <code>mask</code>. If <code>set</code> is non-zero, the bits in <code>mask</code> are OR‑combined into <code>battery_values.status</code>; if <code>set</code> is zero, those bits are cleared.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">set</td><td>Non-zero to set the flags, zero to clear them. </td></tr>
    <tr><td class="paramname">mask</td><td>Bitmask indicating which status flags to modify. </td></tr>
  </table>
  </dd>
</dl>

</div>
</div>
<a id="a5212becce11bf07c1a0b4a2b2e260629" name="a5212becce11bf07c1a0b4a2b2e260629"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a5212becce11bf07c1a0b4a2b2e260629">&#9670;&#160;</a></span>battery_set_time_per_measurement()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void battery_set_time_per_measurement </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Set the measurement interval for the battery monitoring cycle. </p>
<p>This function updates the global <code>battery_values.time_per_measurement</code> field to specify how long (in milliseconds) has elapsed between successive measurements of voltages and temperatures.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">time_ms</td><td>Measurement interval in milliseconds. </td></tr>
  </table>
  </dd>
</dl>

</div>
</div>
<a id="af385b966f1d9efcea35e6f937d05aad5" name="af385b966f1d9efcea35e6f937d05aad5"></a>
<h2 class="memtitle"><span class="permalink"><a href="#af385b966f1d9efcea35e6f937d05aad5">&#9670;&#160;</a></span>battery_stop_balancing()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void battery_stop_balancing </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Ceases all cell balancing operations. </p>
<p>Stops all active cell balancing operations.</p>
<p>This function clears the per‑cell balance mask for every ADBMS client, then issues the updated discharge‑control command to stop all balancing. </p>

</div>
</div>
<a id="a778f618f566846d1286db3b4639542c1" name="a778f618f566846d1286db3b4639542c1"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a778f618f566846d1286db3b4639542c1">&#9670;&#160;</a></span>battery_volt2celsius()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">uint8_t battery_volt2celsius </td>
          <td>(</td>
          <td class="paramtype">uint16_t&#160;</td>
          <td class="paramname"><em>volt_100uV</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Convert a raw voltage reading to temperature in degrees Celsius. </p>
<p>Converts raw voltage (in 100 µV units) to temperature in °C.</p>
<p>This function applies a 10th‑order calibration polynomial to the input voltage (expressed in units of 100 µV) to compute the corresponding temperature.</p>
<p>Boundary conditions:</p><ul>
<li>If the reading is above 23000 (i.e. &gt; 2.3 V), returns 0 °C.</li>
<li>If the reading is below 2000 (i.e. &lt; 0.2 V), returns 100 °C.</li>
</ul>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">volt_100uV</td><td>Voltage reading in units of 100 µV. </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>Temperature in degrees Celsius as an 8‑bit unsigned integer. </dd></dl>

</div>
</div>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8
</small></address>
</body>
</html>
